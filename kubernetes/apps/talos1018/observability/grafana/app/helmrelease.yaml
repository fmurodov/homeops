---
# yaml-language-server: $schema=https://k8s-schemas.bjw-s.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: grafana
spec:
  chart:
    spec:
      chart: grafana
      sourceRef:
        kind: HelmRepository
        name: grafana
  interval: 1h0m0s
  values:
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        memory: 512Mi

    # Admin credentials — "breaking glass" password login
    admin:
      existingSecret: grafana-secret
      userKey: admin-user
      passwordKey: admin-password

    # Persistence via pre-created PVC
    persistence:
      enabled: true
      existingClaim: grafana-data

    # OIDC secrets injected as env vars; referenced in grafana.ini via $${...} escaping.
    # Flux postBuild converts $${ → ${, then Grafana resolves ${VAR} from the pod env at runtime.
    envValueFrom:
      GF_OIDC_CLIENT_ID:
        secretKeyRef:
          name: grafana-secret
          key: OIDC_CLIENT_ID
      GF_OIDC_CLIENT_SECRET:
        secretKeyRef:
          name: grafana-secret
          key: OIDC_CLIENT_SECRET

    grafana.ini:
      server:
        root_url: https://grafana.${CLUSTER_DOMAIN}
      auth:
        login_maximum_inactive_lifetime_duration: 1d
        login_maximum_duration: 30d
      auth.generic_oauth:
        enabled: true
        name: Pocket ID
        client_id: $${GF_OIDC_CLIENT_ID}
        client_secret: $${GF_OIDC_CLIENT_SECRET}
        scopes: openid profile email groups
        auth_url: https://pid.${DOMAIN}/authorize
        token_url: https://pid.${CLUSTER_DOMAIN}/api/oidc/token
        api_url: https://pid.${CLUSTER_DOMAIN}/api/oidc/userinfo
        auto_sign_up: true
        groups_attribute_path: groups
        role_attribute_path: contains(groups[*], 'grafana-admin') && 'Admin' || 'Viewer'

    # Grafana plugins
    plugins:
      - victoriametrics-logs-datasource

    # Datasources
    datasources:
      datasources.yaml:
        apiVersion: 1
        datasources:
          - name: VictoriaMetrics
            type: prometheus
            url: http://victoria-metrics-victoria-metrics-single-server.observability.svc.cluster.local:8428
            isDefault: true
            jsonData:
              timeInterval: "30s"
          - name: VictoriaLogs
            type: victoriametrics-logs-datasource
            url: http://victoria-logs-victoria-logs-single-server.observability.svc.cluster.local:9428
            jsonData:
              maxLines: 1000
          - name: Alertmanager
            type: alertmanager
            url: http://alertmanager.observability.svc.cluster.local:9093
            jsonData:
              implementation: prometheus

    # Dashboards
    dashboardProviders:
      dashboardproviders.yaml:
        apiVersion: 1
        providers:
          - name: "default"
            orgId: 1
            folder: ""
            type: file
            disableDeletion: false
            editable: true
            options:
              path: /var/lib/grafana/dashboards/default
    dashboards:
      default:
        node-exporter-full:
          gnetId: 1860
          revision: 37
          datasource: VictoriaMetrics
        kubernetes-views-global:
          gnetId: 15757
          revision: 43
          datasource: VictoriaMetrics
        kubernetes-views-pods:
          gnetId: 15760
          revision: 36
          datasource: VictoriaMetrics
        kubernetes-views-namespaces:
          gnetId: 15758
          revision: 42
          datasource: VictoriaMetrics
        victorialogs-single-node:
          gnetId: 22084
          revision: 6
          datasource: VictoriaLogs
        fluent-bit:
          gnetId: 18855
          revision: 1
          datasource: VictoriaMetrics
        ingress-nginx:
          gnetId: 9614
          revision: 1
          datasource: VictoriaMetrics
        cert-manager:
          gnetId: 20842
          revision: 3
          datasource: VictoriaMetrics
        longhorn:
          gnetId: 16888
          revision: 9
          datasource: VictoriaMetrics
        cilium-agent:
          gnetId: 16611
          revision: 1
          datasource: VictoriaMetrics
        cilium-hubble:
          gnetId: 16613
          revision: 1
          datasource: VictoriaMetrics
        n8n-system-health:
          gnetId: 24474
          revision: 1
          datasource: VictoriaMetrics
        n8n-workflow-analytics:
          gnetId: 24475
          revision: 1
          datasource: VictoriaMetrics
        cloudflare-tunnels:
          gnetId: 17457
          revision: 6
          datasource: VictoriaMetrics
        alertmanager:
          gnetId: 9578
          revision: 4
          datasource: VictoriaMetrics
        vmalert:
          gnetId: 14950
          revision: 18
          datasource: VictoriaMetrics

    # Ingress
    ingress:
      enabled: true
      ingressClassName: nginx
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt
        gethomepage.dev/enabled: "true"
        gethomepage.dev/group: Observability
        gethomepage.dev/icon: sh-grafana.svg
        gethomepage.dev/name: Grafana
        gethomepage.dev/app: grafana
      path: /
      hosts:
        - grafana.${CLUSTER_DOMAIN}
      tls:
        - secretName: grafana-tls
          hosts:
            - grafana.${CLUSTER_DOMAIN}
