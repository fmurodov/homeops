---
# yaml-language-server: $schema=https://k8s-schemas.bjw-s.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: victoria-metrics
spec:
  chart:
    spec:
      chart: victoria-metrics-single
      sourceRef:
        kind: HelmRepository
        name: vm
  interval: 1h0m0s
  values:
    rbac:
      create: true
    serviceAccount:
      create: true
    server:
      enabled: true
      extraArgs:
        httpListenAddr: "[::]:8428"
        enableTCP6: "true"
      retentionPeriod: "7d"
      persistentVolume:
        enabled: true
        existingClaim: victoria-metrics-data
      resources:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          memory: 512Mi
      service:
        clusterIP: ""
      ingress:
        enabled: true
        ingressClassName: nginx
        annotations:
          cert-manager.io/cluster-issuer: letsencrypt
          gethomepage.dev/enabled: "true"
          gethomepage.dev/group: Observability
          gethomepage.dev/icon: si-victoriametrics
          gethomepage.dev/name: VictoriaMetrics
          gethomepage.dev/app: victoria-metrics
        hosts:
          - name: vm.${CLUSTER_DOMAIN}
            path:
              - /
            port: http
        tls:
          - secretName: victoria-metrics-tls
            hosts:
              - vm.${CLUSTER_DOMAIN}
      # Built-in scraping (replaces separate vmagent)
      scrape:
        enabled: true
        config:
          global:
            scrape_interval: 30s
          scrape_configs:
            # Kubernetes API server
            - job_name: kubernetes-api-server
              kubernetes_sd_configs:
                - role: endpoints
              scheme: https
              tls_config:
                insecure_skip_verify: true
                ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
              bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
              relabel_configs:
                - source_labels:
                    - __meta_kubernetes_service_namespace
                    - __meta_kubernetes_service_name
                    - __meta_kubernetes_endpoint_port_name
                  regex: default;kubernetes;https
                  action: keep

            # Kubelet metrics
            - job_name: kubernetes-kubelet
              kubernetes_sd_configs:
                - role: node
              scheme: https
              tls_config:
                insecure_skip_verify: true
              bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
              relabel_configs:
                - action: labelmap
                  regex: __meta_kubernetes_node_label_(.+)
                - source_labels:
                    - __address__
                  regex: (.+):(.+)
                  target_label: __address__
                  replacement: "$${1}:10250"

            # cAdvisor (container metrics via kubelet)
            - job_name: kubernetes-cadvisor
              kubernetes_sd_configs:
                - role: node
              scheme: https
              metrics_path: /metrics/cadvisor
              tls_config:
                insecure_skip_verify: true
              bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
              relabel_configs:
                - action: labelmap
                  regex: __meta_kubernetes_node_label_(.+)
                - source_labels:
                    - __address__
                  regex: (.+):(.+)
                  target_label: __address__
                  replacement: "$${1}:10250"

            # Pod autodiscovery via prometheus.io annotations
            - job_name: kubernetes-pods
              kubernetes_sd_configs:
                - role: pod
              relabel_configs:
                - source_labels:
                    - __meta_kubernetes_pod_annotation_prometheus_io_scrape
                  action: keep
                  regex: "true"
                - source_labels:
                    - __meta_kubernetes_pod_annotation_prometheus_io_scheme
                  action: replace
                  target_label: __scheme__
                  regex: (https?)
                  replacement: $1
                - source_labels:
                    - __meta_kubernetes_pod_annotation_prometheus_io_path
                  action: replace
                  target_label: __metrics_path__
                  regex: (.+)
                  replacement: $1
                - source_labels:
                    - __address__
                    - __meta_kubernetes_pod_annotation_prometheus_io_port
                  action: replace
                  regex: ([^:]+)(?::\d+)?;(\d+)
                  target_label: __address__
                  replacement: $1:$2
                - action: labelmap
                  regex: __meta_kubernetes_pod_label_(.+)
                - source_labels:
                    - __meta_kubernetes_namespace
                  action: replace
                  target_label: namespace
                - source_labels:
                    - __meta_kubernetes_pod_name
                  action: replace
                  target_label: pod

            # Node Exporter
            - job_name: node-exporter
              kubernetes_sd_configs:
                - role: endpoints
              relabel_configs:
                - source_labels:
                    - __meta_kubernetes_service_name
                  action: keep
                  regex: prometheus-node-exporter
                - action: labelmap
                  regex: __meta_kubernetes_node_label_(.+)

            # kube-state-metrics
            - job_name: kube-state-metrics
              kubernetes_sd_configs:
                - role: endpoints
              relabel_configs:
                - source_labels:
                    - __meta_kubernetes_service_name
                  action: keep
                  regex: kube-state-metrics

            # Longhorn manager metrics
            - job_name: longhorn
              kubernetes_sd_configs:
                - role: endpoints
                  namespaces:
                    names:
                      - longhorn-system
              relabel_configs:
                - source_labels:
                    - __meta_kubernetes_service_name
                    - __meta_kubernetes_endpoint_port_name
                  action: keep
                  regex: longhorn-backend;manager
    # Standalone charts are used for these â€” disable the bundled ones
    vmagent:
      enabled: false
    vmalert:
      enabled: false
    vmauth:
      enabled: false
